#!/usr/bin/env bash
set -euo pipefail

# Usage: ./deploy_zbt.sh <kerberos-username>
# Example: ./deploy_zbt.sh sanjithu

KERB="${1:-}"
HOST="athena.dialup.mit.edu"
REMOTE_PATH="/mit/zbt/web_scripts"

if [[ -z "$KERB" ]]; then
  echo "Usage: $0 <kerberos-username>"
  exit 1
fi

echo "Building Vite app..."
yarn run build

echo "Copying ./dist to ${KERB}@${HOST}:${REMOTE_PATH}"
rsync -avz --delete -e ssh ./dist/ "${KERB}@${HOST}:${REMOTE_PATH}/"

echo "Updating public read permissions on remote..."
ssh "${KERB}@${HOST}" bash -lc "set -e
  fs setacl /mit/zbt                 system:anyuser read || true
  fs setacl '${REMOTE_PATH}'         system:anyuser read || true
  find '${REMOTE_PATH}' -type d -exec fs setacl -dir {} -acl system:anyuser read \; || true
"

echo "Verifying deployment..."
curl -I --max-time 5 https://zbt.mit.edu/ || true

echo "Deploy complete. Hard-refresh browser to see changes."